<!DOCTYPE html>
<html lang="ce">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#7a586e"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#7a586e">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"hayahayao.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Stream API, but frontend">
<meta property="og:type" content="article">
<meta property="og:title" content="å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ">
<meta property="og:url" content="https://hayahayao.github.io/2020/09/16/%E5%89%8D%E7%AB%AF%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%A1%88/index.html">
<meta property="og:site_name" content="ã•ãŠã‚Šã®Blog">
<meta property="og:description" content="Stream API, but frontend">
<meta property="og:locale">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/12/23/16f304e310ea9e49?imageslim">
<meta property="article:published_time" content="2020-09-16T03:26:00.000Z">
<meta property="article:modified_time" content="2023-08-30T08:30:07.341Z">
<meta property="article:author" content="hayahayao">
<meta property="article:tag" content="Stream">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://user-gold-cdn.xitu.io/2019/12/23/16f304e310ea9e49?imageslim">


<link rel="canonical" href="https://hayahayao.github.io/2020/09/16/%E5%89%8D%E7%AB%AF%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%A1%88/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"ce","comments":true,"permalink":"https://hayahayao.github.io/2020/09/16/%E5%89%8D%E7%AB%AF%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%A1%88/","path":"2020/09/16/å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ/","title":"å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ | ã•ãŠã‚Šã®Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">ã•ãŠã‚Šã®Blog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">ç‡ƒãˆã¦æ•£ã£ãŸèŠ±ã¨ãªã‚Œã€‚</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#JSZip"><span class="nav-number">1.</span> <span class="nav-text">JSZip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#StreamSaver-js"><span class="nav-number">2.</span> <span class="nav-text">StreamSaver.js</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8E-JSZip-%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8%EF%BC%9F"><span class="nav-number">2.1.</span> <span class="nav-text">ä¸ JSZip ç»“åˆä½¿ç”¨ï¼Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mitm-sw-%E9%85%8D%E7%BD%AE"><span class="nav-number">2.2.</span> <span class="nav-text">mitm + sw é…ç½®</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">hayahayao</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/hayahayao" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;hayahayao" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="ce">
    <link itemprop="mainEntityOfPage" href="https://hayahayao.github.io/2020/09/16/%E5%89%8D%E7%AB%AF%E5%A4%A7%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="hayahayao">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ã•ãŠã‚Šã®Blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ | ã•ãŠã‚Šã®Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          å‰ç«¯å¤§æ–‡ä»¶ä¸‹è½½æ–¹æ¡ˆ
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-09-16 11:26:00" itemprop="dateCreated datePublished" datetime="2020-09-16T11:26:00+08:00">2020-09-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2023-08-30 16:30:07" itemprop="dateModified" datetime="2023-08-30T16:30:07+08:00">2023-08-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/frontend/" itemprop="url" rel="index"><span itemprop="name">frontend</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>Stream API, but frontend</p>
</blockquote>
<span id="more"></span>

<p>åœ¨ä¸šåŠ¡ä¸­é‡åˆ°éœ€è¦ç”¨æˆ·ä¸‹è½½ä¸€ä¸ªå¾ˆå·¨å¤§çš„ zip åŒ…çš„åœºæ™¯ï¼Œå†…å®¹é€šå¸¸æ˜¯ä¸€å †å¾ˆå°çš„ï¼ˆå›¾ç‰‡ï¼‰æ–‡ä»¶æ‰“åŒ…åˆ°ä¸€èµ·ã€‚ä¼ ç»Ÿçš„ä¸‹è½½æ–¹æ¡ˆæ˜¯ç›´æ¥ä¿®æ”¹ <code>window.location.href=åç«¯æä¾›çš„ä¸‹è½½é“¾æ¥</code>ï¼Œä¹‹ååç«¯ä¸€è¾¹å»ä¸‹è½½è¦æ‰“åŒ…çš„æ–‡ä»¶ï¼Œä¸€è¾¹æŠŠæ‰“åŒ…å¥½çš„ä¸œè¥¿å†™å…¥è¿™ä¸ªé“¾æ¥ã€‚</p>
<p>å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼Œå¦‚æœæ–‡ä»¶å¾ˆå¤§ï¼Œè¿™ä¸ªé“¾æ¥éœ€è¦ä¸€ç›´ä¿æŒï¼Œç›¸å½“äºè¿™ä¸ªæ¥å£ä¸€ç›´å¼€ç€æ²¡æœ‰ç»“æŸï¼ˆè¿ç»´åŒå­¦å¾ˆä¸å¼€å¿ƒï¼‰ï¼›è€Œä¸”ä¸€æ—¦ä¸­é—´å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œå·²ç»ä¸‹è½½çš„ä¸œè¥¿ä¹Ÿå…¨éƒ¨åºŸäº†ï¼Œä¸‹æ¬¡è¿˜è¦é‡æ–°å¼€å§‹ï¼ˆå¯ä»¥é€šè¿‡è®¾ç½® http range å¤´ç­‰æ–¹æ³•å®ç°æ–­ç‚¹ç»­ä¼ ï¼‰ã€‚</p>
<p>é‚£ä¹ˆï¼Œåæ­£åç«¯ä¹Ÿæ²¡æœ‰å­˜è¿™ä¸ªå¤§æ–‡ä»¶ï¼Œä¹Ÿæ˜¯ç°ç”¨ç°ç”Ÿæˆçš„ï¼Œå¯ä¸å¯ä»¥æŠŠè¿™ä¸ªå·¥ä½œè½¬ç§»åˆ°å‰ç«¯ï¼Ÿå¦‚æœæŠŠè¯·æ±‚ä¸€å †å°æ–‡ä»¶çš„å·¥ä½œè½¬ç§»åˆ°æµè§ˆå™¨ï¼Œé‚£å°±ç»•å¼€äº†ä¸‹è½½æ¥å£çš„æ—¶é—´é™åˆ¶ï¼Œè€Œä¸”æˆ‘ä»¬çŸ¥é“å“ªäº›æ–‡ä»¶å·²ç»ä¸‹è½½äº†ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›æ“ä½œä¿ç•™ä½å·²ç»ä¸‹è½½çš„æ–‡ä»¶ï¼Ÿ</p>
<h2 id="JSZip"><a href="#JSZip" class="headerlink" title="JSZip"></a>JSZip</h2><p>åœ¨çŸ¥é“ Streams API è¿™ç§é«˜çº§ç©æ„ä¹‹å‰ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºæµè§ˆå™¨ä¸­çš„ js ä»£ç æ˜¯ä¸èƒ½åšæµæ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½ä¸€è¾¹ä¸‹ä¸€è¾¹å¾€æœ¬åœ°å†™ã€‚é‚£ä¹ˆä¸€ä¸ªæœ€ç›´æ¥çš„æƒ³æ³•å°±æ˜¯æŠŠæ–‡ä»¶éƒ½ä¸‹åˆ°å†…å­˜ä¸­ï¼Œä¹‹åè°ƒç”¨ <a target="_blank" rel="noopener" href="https://github.com/Stuk/jszip">JSZip</a> ç»Ÿä¸€æ‰“åŒ…ï¼Œå†è°ƒç”¨ <a target="_blank" rel="noopener" href="https://github.com/eligrey/FileSaver.js/">FileSaver.js</a> è§¦å‘ä¿å­˜æ“ä½œã€‚æ–‡ä»¶æ•°æ®ä¸€ç›´æ˜¯ä»¥ blob æ–¹å¼ä¼ é€’çš„ï¼Œç®€å•çš„ä»£ç ç¤ºæ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; saveAs &#125; <span class="keyword">from</span> <span class="string">&#x27;file-saver&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">JSZip</span> <span class="keyword">from</span> <span class="string">&#x27;jszip&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> urls = [xxx] <span class="comment">// ä¸€å †éœ€è¦ä¸‹è½½çš„æ–‡ä»¶ url</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ZIP</span> = <span class="keyword">new</span> <span class="title function_">JSZIP</span>()</span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(urls.<span class="title function_">map</span>(<span class="function">(<span class="params">url, index</span>) =&gt;</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetch</span>(url).<span class="title function_">then</span>(<span class="function"><span class="params">response</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">            zip.<span class="title function_">file</span>(url, response.<span class="title function_">blob</span>()) <span class="comment">// blob å“¦</span></span><br><span class="line">            <span class="title function_">resolve</span>()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;))).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    zip.<span class="title function_">generateAsync</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;blob&#x27;</span> &#125;).<span class="title function_">then</span>(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">saveAs</span>(content, <span class="string">&#x27;hello.zip&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>å¾ˆå®¹æ˜“æƒ³è±¡ï¼Œè¿™ç§æ–¹å¼å¯¹å†…å­˜æ¶ˆè€—éå¸¸å¤§ï¼Œè€Œä¸”éšç€æ–‡ä»¶æ•°é‡çš„å¢é•¿ï¼Œæ‰“åŒ… zip è¿™ä¸ªè¿‡ç¨‹ä¼šè¶Šæ¥è¶Šæ…¢ï¼Œæ—¶é—´å½“ç„¶ä¹Ÿä¸æ˜¯çº¿æ€§å¢é•¿é‚£ä¹ˆç®€å•ã€‚å®é™…æµ‹è¯•ç»“æœä¹Ÿå¦‚æ­¤ï¼ˆä¸è¿‡å®é™…æµ‹è¯•ï¼Œèƒ½å¤„ç†çš„æ–‡ä»¶å¤§å°è¶…å‡ºäº†æˆ‘çš„æƒ³è±¡ï¼Œå‡ ä¸ª G éƒ½ä¸æ˜¯é—®é¢˜ï¼Œå°±æ˜¯æ…¢è€Œå·²ï¼‰ã€‚</p>
<h2 id="StreamSaver-js"><a href="#StreamSaver-js" class="headerlink" title="StreamSaver.js"></a>StreamSaver.js</h2><p>å‰ç½®é˜…è¯»ï¼š<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904029244358670">ä» Fetch åˆ° Streams â€”â€” ä»¥æµçš„è§’åº¦å¤„ç†ç½‘ç»œè¯·æ±‚</a></p>
<p>å•Šï¼Œæµï¼Œå®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚</p>
<p>æœ‰äº†è¯»å†™æµçš„èƒ½åŠ›ï¼Œè¿˜éœ€è¦è§£å†³çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¦‚ä½•ç»´æŒä¸€ä¸ªæŒç»­çš„é€šé“ï¼Œä¿è¯èƒ½å¤Ÿä¸€è¾¹åœ¨ä¸‹è½½ï¼Œä¸€è¾¹æŠŠä¸‹è½½çš„ä¸œè¥¿å†™åˆ°æœ¬åœ°ã€‚</p>
<p>å•Šå“ˆï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ¨¡ä»¿åç«¯ï¼Œåˆ¶é€ ä¸€ä¸ªï¼ˆä¸å­˜åœ¨çš„ï¼‰ä¸‹è½½é“¾æ¥ï¼Œç„¶åç”¨ <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API">Service Worker</a> å»æ‹¦æˆªå¯¹è¿™ä¸ªé“¾æ¥çš„è¯·æ±‚ï¼ŒæŒç»­å¾€è¿™é‡Œé¢å†™å°±å¯ä»¥äº†ï¼</p>
<p>è¿™å°±æ˜¯ <a target="_blank" rel="noopener" href="https://github.com/jimmywarting/StreamSaver.js">StreamSaver.js</a> æ‰€åšçš„äº‹æƒ…ã€‚ç®€å•çš„ä»£ç ç¤ºæ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">StreamSaver</span> <span class="keyword">from</span> <span class="string">&#x27;streamsaver&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ZipStream</span> <span class="keyword">from</span> <span class="string">&#x27;./zip-stream.js&#x27;</span> <span class="comment">// ä½œè€…æä¾›çš„ zip å·¥å…·</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> urls = [xxx] <span class="comment">// ä¸€å †éœ€è¦ä¸‹è½½çš„æ–‡ä»¶ url</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> fileStream = <span class="title class_">StreamSaver</span>.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;hello.zip&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> readableZipStream = <span class="keyword">new</span> <span class="title class_">ZipStream</span>(&#123;</span><br><span class="line">    <span class="keyword">async</span> <span class="title function_">pull</span>(<span class="params">control</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> it = url.<span class="title function_">next</span>()</span><br><span class="line">        <span class="keyword">if</span> (it.<span class="property">done</span>) &#123;</span><br><span class="line">            control.<span class="title function_">close</span>()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="title function_">fetch</span>(url)</span><br><span class="line">            control.<span class="title function_">enqueue</span>(&#123;</span><br><span class="line">                <span class="attr">name</span>: url,</span><br><span class="line">                <span class="attr">stream</span>: <span class="function">() =&gt;</span> response.<span class="property">body</span> <span class="comment">// è¿™ä¸ªæ˜¯ ReadableStream ç±»å‹ï¼web æ ‡å‡†ä¸‡å²ï¼</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">WritableStream</span> &amp;&amp; readableZipStream.<span class="property">pipeTo</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> readableZipStream.<span class="title function_">pipeTo</span>(fileStream).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            that.<span class="property">dialogExportProcess</span> = <span class="literal">false</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>ä¸Šè¿°çš„ä»£ç å®ç°äº†æ¯æ¬¡ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ -&gt; å‘æµä¸­å†™å…¥ä¸€ä¸ªæ–‡ä»¶è¿™æ ·ç±»ä¼¼å•çº¿ç¨‹ï¼ˆï¼Ÿï¼‰çš„å¤„ç†è¿‡ç¨‹ï¼Œé‚£ä¹ˆèƒ½å¦å®ç°å¦‚<a target="_blank" rel="noopener" href="https://juejin.im/post/6844904029244358670">ä» Fetch åˆ° Streams â€”â€” ä»¥æµçš„è§’åº¦å¤„ç†ç½‘ç»œè¯·æ±‚</a>è¿™ç¯‡ä¸­æ‰€è¯´ï¼Œç»“åˆ JSZipï¼Œåœ¨ä¸€æ¬¡ <code>pull</code> è¿‡ç¨‹ä¸­ä¸‹è½½å¥½å‡ ä¸ªï¼Œç„¶åç”¨ JSZip æŠŠè¿™å¥½å‡ ä¸ªæ–‡ä»¶å‹æˆä¸€å—æµä¸€å£æ°”å†™å…¥å‘¢ï¼Ÿ</p>
<h3 id="ä¸-JSZip-ç»“åˆä½¿ç”¨ï¼Ÿ"><a href="#ä¸-JSZip-ç»“åˆä½¿ç”¨ï¼Ÿ" class="headerlink" title="ä¸ JSZip ç»“åˆä½¿ç”¨ï¼Ÿ"></a>ä¸ JSZip ç»“åˆä½¿ç”¨ï¼Ÿ</h3><p><img src="https://user-gold-cdn.xitu.io/2019/12/23/16f304e310ea9e49?imageslim" alt="ä¸ JSZip ç»“åˆä½¿ç”¨"></p>
<p>é¦–å…ˆï¼Œä½¿ç”¨æ–‡ç« é‡Œæè¿°çš„ <code>generateInternalStream()</code> è¿™ä¸ªæ–¹æ³•æ˜¯è¡Œä¸é€šçš„ï¼ŒJSZip çš„ <code>StreamHelper</code> API åªæ˜¯æ¨¡æ‹Ÿäº†æµçš„å®ç°ï¼Œä½†è¿”å›å€¼å¹¶ä¸æ˜¯ç¬¦åˆ Stream API æ ‡å‡†çš„ <code>ReadableStream</code>&#x2F;<code>WritableStream</code> ç±»å‹ã€‚</p>
<p>ä¸è¿‡ blob æ€»æ˜¯å¯è¡Œçš„ï¼Œå¦‚æœåœ¨ JSZip é‡Œé¢ç”¨ blob å¤„ç†ï¼Œåˆ°æ—¶å€™å†ç”¨ <code>blob.stream()</code> è¿™ç§æ–¹æ³•è½¬æˆ <code>ReadableStream</code> å†™å…¥æµä¸­ï¼Œä¼¼ä¹å¬ä¸Šå»ä¸é”™ã€‚ä¸è¿‡æˆ‘åœ¨å®é™…æ“ä½œçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œ<code>control.enqueue()</code> æ—¶æ–‡ä»¶åæ€ä¹ˆå¤„ç†ï¼Ÿæˆ‘è¯•ç€å†™æˆä»¥ &#x2F; ç»“å°¾è¡¨ç¤ºæˆ‘è¦å†™å…¥ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸è¿‡ä¼¼ä¹å¹¶ä¸èƒ½è¾¾åˆ°é¢„æƒ³æ•ˆæœğŸ¤”â€¦</p>
<h3 id="mitm-sw-é…ç½®"><a href="#mitm-sw-é…ç½®" class="headerlink" title="mitm + sw é…ç½®"></a>mitm + sw é…ç½®</h3><p>æœ€åå†™ä¸€ä¸‹å®é™…ä½¿ç”¨ StreamSaver æ—¶æ‰€éœ€çš„ sw é…ç½®ã€‚</p>
<p>ç›´æ¥è·‘ä½œè€…ç»™å‡ºçš„ç¤ºä¾‹ä»£ç ä¼šå‘ç°ï¼Œè¿è¡Œä¸‹è½½ä¹‹åé¡µé¢ä¸Šä¼šå¤šå‡ºä¸¤ä¸ªè¿™æ ·çš„ iframe</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">hidden</span>=<span class="string">&quot;&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0&quot;</span> <span class="attr">name</span>=<span class="string">&quot;iframe&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">hidden</span>=<span class="string">&quot;&quot;</span> <span class="attr">src</span>=<span class="string">&quot;https://jimmywarting.github.io/StreamSaver.js/null/637501/archive.zip&quot;</span> <span class="attr">name</span>=<span class="string">&quot;iframe&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>emmï¼Œç¬¬äºŒä¸ªçœ‹èµ·æ¥åƒæ˜¯ä¸‹è½½é“¾æ¥çš„æ ·å­ï¼ˆå½“ç„¶æ˜¯æˆ‘ä»¬åˆ¶é€ çš„ï¼Œå®é™…æ‰“å¼€é‡Œé¢ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼‰ï¼Œç¬¬ä¸€ä¸ªçš„è¯æ‰“å¼€å‘ç°é‡Œé¢æœ‰ä¸€äº› js ä»£ç ï¼Œä¼¼ä¹æ˜¯æ³¨å†Œäº† sw çš„æ ·å­ã€‚</p>
<p>ä½†æ˜¯è¿™åŸŸåï¼Œè¿™å‰ç¼€ï¼Œéƒ½æ˜¯å•¥ï¼Ÿèƒ½ä¸èƒ½æåˆ°è‡ªå·±æœ¬åœ°ï¼Ÿåˆ°æ—¶å€™é¡¹ç›®ä¸Šçº¿è¿˜å¸¦ç€åˆ«äººçš„ github.io å¯ä¸è¡Œâ€¦</p>
<p>æ¥çœ‹ä¸‹ä½œè€…çš„è§£é‡Šï¼š</p>
<blockquote>
<p>So the one and only other solution is to do what the server does: Send a stream with Content-Disposition header to tell the browser to save the file. But we donâ€™t have a server or the content isnâ€™t on a server! So the solution is to create a service worker that can intercept request and use respondWith() and act as a server.</p>
<p>But a service workers are only allowed in secure contexts and it requires some effort to put up. Most of the time you are working in the main thread and the service worker are only alive for &lt; 5 minutes before it goes idle.</p>
<p>1.So StreamSaver creates a own man in the middle that installs the service worker in a secure context hosted on github static pages. either from a iframe (in secure context) or a new popup if your page is insecure.</p>
<p>2.Transfer the stream (or DataChannel) over to the service worker using postMessage.</p>
<p>3.And then the worker creates a download link that we then open.</p>
<p>if a â€œtransferableâ€ readable stream was not passed to the service worker then the mitm will also try to keep the service worker alive by pinging it every x second to prevent it from going idle.</p>
</blockquote>
<p>å—¯ï¼Œè¿™ä¸ª mitm.html ç¡®å®æ˜¯åœ¨å®Œæˆ service worker æ³¨å†Œçš„å·¥ä½œã€‚è€Œ service worker æ³¨å†Œæœ‰å¾ˆå¤šé™åˆ¶ï¼šï¼ˆä¸ºæ–¹ä¾¿è¯´æ˜ï¼Œä¸‹æ–‡ä¸­ mitm.html ä»£è¡¨â€œæ³¨å†Œ service worker çš„ä½ç½®â€œï¼Œsw.js ä»£è¡¨â€œservice worker æ‰€åœ¨çš„ä½ç½®â€œï¼‰</p>
<ul>
<li>åªèƒ½åœ¨ HTTPS&#x2F;localhost ç¯å¢ƒä¸‹æ³¨å†Œï¼ˆå¦åˆ™æŠ¥é”™å¦‚ <code>Failed to register a ServiceWorker: An SSL certificate error occurred when fetching the script.</code>ï¼‰</li>
<li>è¦æ³¨å†Œçš„ sw.js æ–‡ä»¶å¿…é¡»å’Œæ³¨å†Œå®ƒçš„ mitm.html åŒæºï¼ˆå¦åˆ™æŠ¥é”™å¦‚ <code>Failed to register ServiceWorker. The origin of the provider scriptURL(&#39;sw.js æ‰€åœ¨çš„åŸŸ&#39;) does not match the current origin (&#39;mitm.html æ‰€åœ¨çš„åŸŸ&#39;).</code>ï¼‰</li>
<li>service worker çš„ä½œç”¨åŸŸä¸èƒ½è¶…å‡º sw.js è‡ªå·±æ‰€åœ¨ä½ç½®ï¼ˆå¦åˆ™æŠ¥é”™å¦‚ <code>Failed to register a ServiceWorker: The path of the provided scope (&#39;mitm.html æ‰€åœ¨çš„è·¯å¾„&#39;) is not under the max scope allowed (&#39;sw.js æ‰€åœ¨çš„è·¯å¾„&#39;). Adjust the scope, move the Service Worker script, or use the Service-Worker-Allowed HTTP header to allow the scope.</code>ï¼‰</li>
</ul>
<p>æ‰€ä»¥ä½œè€…é»˜è®¤æŠŠ sw æ³¨å†Œåœ¨äº†ä»–è‡ªå·±çš„çš„ github é™æ€é¡µé¢ä¸Šï¼Œè€Œå¦‚æœæˆ‘ä»¬æƒ³åœ¨è‡ªå·±çš„åŸŸåä¸Šæ³¨å†Œ swï¼Œå°±éœ€è¦æ³¨æ„ä¸Šé¢ä¸‰ç‚¹é™åˆ¶ï¼š</p>
<ul>
<li>https ç¯å¢ƒé™åˆ¶ï¼šå¦‚ä¸º httpï¼Œå¯ä»¥æŠŠç½‘ç«™æ”¹æˆ https ç„¶åæ‰‹åŠ¨ä¿¡ä»»ä¸‹è¯ä¹¦</li>
<li>åŒæºé™åˆ¶ï¼šå¦‚æœä¸åŒæºï¼Œå¯ä»¥é‡‡ç”¨é…ç½® nginx ä»£ç†è®©å®ƒä»¬çœ‹ä¸Šå»æ˜¯åŒæºçš„</li>
<li>ä½œç”¨åŸŸé™åˆ¶ï¼šå¦‚æœä¸æƒ³ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶çš„ä½ç½®ï¼Œå¯ä»¥é€šè¿‡ nginx åœ¨ sw.js çš„ response header ä¸­åŠ å…¥ <code>Service-Worker-Allowed</code> è¿™ä¸ªå¤´</li>
</ul>
<p><strong>å‚è€ƒï¼š</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Streams_API">Streams API</a> </li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API">Service Worker</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jimmywarting/StreamSaver.js">StreamSaver.js</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Stuk/jszip">JSZip</a></li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Stream/" rel="tag"># Stream</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2020/08/18/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0-Javascript%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B/" rel="prev" title="è¯»ä¹¦ç¬”è®°-Javascriptè½»é‡çº§å‡½æ•°å¼ç¼–ç¨‹">
                  <i class="fa fa-angle-left"></i> è¯»ä¹¦ç¬”è®°-Javascriptè½»é‡çº§å‡½æ•°å¼ç¼–ç¨‹
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2020/11/12/%E6%B5%8F%E8%A7%88%E5%99%A8%E8%AF%86%E5%88%AB/" rel="next" title="æµè§ˆå™¨è¯†åˆ«">
                  æµè§ˆå™¨è¯†åˆ« <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">hayahayao</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
